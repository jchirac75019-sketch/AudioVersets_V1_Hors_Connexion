<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover" />
  <meta name="theme-color" content="#1e40af" />
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg'><text y='1em' font-size='1em'>ğŸ•Œ</text></svg>">

  <title>Quiz Coran - ØªØ·Ø¨ÙŠÙ‚ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù‚Ø±Ø¢Ù†</title>
  <!-- Manifest inline (data URL) -->
  <link rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Amiri&display=swap">
<!-- <link rel="stylesheet" href="style.css"> -->

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{--blue:#1e40af;--green:#059669;--red:#dc2626;--bg1:#ffffff;--bg2:#f8fafc;--text:#1f2937}
    html,body{height:100%}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Noto Sans","Helvetica Neue",Arial,"Apple Color Emoji","Segoe UI Emoji";background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:var(--text);direction:rtl}
    .app-container{max-width:1200px;margin:0 auto;padding:16px 16px 40px}
    .page{display:none;animation:fade .25s ease}
    .page.active{display:block}
    @keyframes fade{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:none}}
    .header{background:rgba(255,255,255,.95);border-radius:18px;padding:24px;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,.1);margin:16px 0}
    .header h1{color:var(--blue);font-size:clamp(22px,5vw,34px);margin-bottom:8px}
    .subtitle{color:#64748b}
    .card{background:rgba(255,255,255,.95);border-radius:18px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.1);margin:16px 0}
    .section{background:rgba(248,250,252,.88);border:2px solid rgba(30,64,175,.12);border-radius:14px;padding:16px;margin-bottom:16px}
    .section h3{color:var(--blue);text-align:center;margin-bottom:12px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .group{display:flex;flex-direction:column;gap:6px}
    label{font-weight:600;color:#374151;font-size:14px}
    select,input[type=number]{padding:12px 14px;border:2px solid #e5e7eb;border-radius:12px;background:#fff;font-size:16px;direction:rtl}
    select:focus,input[type=number]:focus{outline:none;border-color:var(--blue);box-shadow:0 0 0 3px rgba(30,64,175,.12)}
    .error{display:none;margin-top:4px;font-size:12px;color:var(--red);background:#fef2f2;border:1px solid #fecaca;border-radius:8px;padding:8px 10px}
    .error.show{display:block}
    .stats{text-align:center;margin:12px 0;padding:14px;background:rgba(30,64,175,.08);border:2px solid rgba(30,64,175,.18);border-radius:14px;color:var(--blue);font-weight:700}
    .highlight{color:var(--red);font-weight:800}
    .blue{color:var(--blue);font-weight:800}
    .btn{padding:14px 22px;border:none;border-radius:12px;font-weight:700;cursor:pointer;transition:.2s;min-width:120px}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn-primary{background:linear-gradient(135deg,#1e40af,#3b82f6);color:#fff}
    .btn-neutral{background:#64748b;color:#fff}
    .btn-green{background:var(--green);color:#fff}
    .btn-red{background:var(--red);color:#fff}
    .btn-purple{background:#7c3aed;color:#fff}
    .btn-amber{background:#f59e0b;color:#fff}
    .btn:hover{transform:translateY(-2px);box-shadow:0 8px 18px rgba(0,0,0,.18)}
    .quiz-header{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .badges{display:flex;flex-wrap:wrap;gap:10px}
    .badge{background:#fff;border-radius:12px;padding:10px 12px;box-shadow:0 4px 14px rgba(0,0,0,.08);font-weight:700;color:#374151}
    .badge .ok{color:var(--green)} .badge .ko{color:var(--red)}
    .qwrap{min-height:360px}
    .qcounter{text-align:center;color:#64748b;font-weight:700;margin-bottom:14px}
    .qtext{text-align:center;font-weight:700;line-height:1.7;background:#fff;border-radius:14px;padding:18px;border-right:5px solid var(--blue)}
    .verset,.info{background:#f8fafc;border-radius:14px;padding:18px;border-right:5px solid var(--blue);margin:14px 0;text-align:center}

.verset, .info {
  font-family: 'Amiri', serif;       /* Police coranique Ã©lÃ©gante */
  font-size: 1.2rem;                  /* Augmente lÃ©gÃ¨rement la taille */
  line-height: 1.8;                   /* Confort de lecture */
  background: #f8fafc;
  border-right: 5px solid var(--blue);
  padding: 18px;
  border-radius: 14px;
  margin: 14px 0;
  text-align: center;
}

/* Fond jaune trÃ¨s clair uniquement pour la ligne du verset dans #info */
#info > div:first-child {
  background-color: #fff9c4;  /* jaune trÃ¨s clair */
  border-radius: 8px;
  padding: 6px 10px;
}

/* Met le texte coranique en gras dans le modÃ¨le Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØµÙˆØª */
// #info > div:first-child span#tAudio {
  // font-weight: 700;
// }

/* Met en Ã©vidence le numÃ©ro du verset avec fond jaune */
.info .highlight-verse {
  background-color: #ffeb3b;  /* jaune clair */
  padding: 2px 6px;
  border-radius: 4px;
  color: var(--blue);         /* texte en bleu pour contraste */
  font-weight: 700;
}

/* Fond jaune pour le numÃ©ro du verset */
#info div span#nAudio {
  background-color: #ffeb3b;  /* jaune clair */
  padding: 2px 6px;
  border-radius: 4px;
}

/* Verset coranique - 2 lignes FIXES + scroll VERTICAL */
#info > div:first-child {
  background-color: #fff9c4;  /* jaune trÃ¨s clair */
  border-radius: 8px;
  padding: 10px;
  max-height: 4.7em;  /* EXACTEMENT 2 lignes (1.8em Ã— 2) */
  overflow-y: auto;  /* Scroll VERTICAL si texte dÃ©passe 2 lignes */
  overflow-x: hidden;  /* Pas de scroll horizontal */
  white-space: normal;  /* Texte s'enroule naturellement */
  word-wrap: break-word;
  direction: rtl;
  line-height: 1.8;
  display: block;
}

#info > div:first-child span#tAudio {
  display: inline;
  padding: 2px 6px;
}

/* Fond jaune pour numÃ©ro du verset et nom de la sourate en mode texte */
#textMode .qtext span#vNum,
#textMode .qtext span#sName {
  background-color: #fff9c4;  /* jaune trÃ¨s clair */
  border-radius: 4px;
  padding: 2px 6px;
}

/* Mode texte : verset et nom de la sourate en gras et taille augmentÃ©e */
#textMode .qtext span#vNum,
#textMode .qtext span#sName {
  background-color: #fff9c4;      /* fond jaune trÃ¨s clair */
  border-radius: 4px;
  padding: 2px 6px;
  font-weight: 700;               /* gras */
  font-size: 1.4rem;              /* taille plus grande */
}

.flex-audio {
  display: flex;
  align-items: center;
  gap: 12px;
  justify-content: center;
  flex-wrap: wrap;        /* Permet le retour Ã  la ligne sur mobile */
}

.flex-audio audio {
  flex: 1 1 auto;         /* Le lecteur prend l'espace disponible */
  min-width: 200px;       /* Largeur minimale */
  max-width: 100%;        /* Ne dÃ©passe jamais la largeur du conteneur */
}

.flex-audio button {
  white-space: normal;    /* Permet le retour Ã  la ligne du texte */
  min-width: 120px;       /* Largeur minimale du bouton */
  flex: 0 1 auto;         /* Le bouton s'adapte Ã  son contenu */
  padding: 10px 16px;     /* Padding ajustÃ© pour mobile */
  font-size: 14px;        /* Taille de texte adaptÃ©e */
}

/* Media query pour mobile */
@media (max-width: 768px) {
  .flex-audio {
    flex-direction: column;  /* Empile le lecteur et le bouton verticalement */
    gap: 8px;
  }
  
  .flex-audio audio {
    width: 100%;             /* Le lecteur prend toute la largeur */
    max-width: 100%;
  }
  
  .flex-audio button {
    width: 100%;             /* Le bouton prend toute la largeur */
    max-width: 100%;
    font-size: 15px;         /* LÃ©gÃ¨rement plus grand sur mobile */
    padding: 12px 20px;
  }
}

    .controls{text-align:center;margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
    .audio{margin-bottom:12px;text-align:center}
    .audio audio{width:100%;max-width:420px}
    .history .item{background:#fff;border-radius:12px;margin:10px 0;padding:12px;border-right:5px solid;box-shadow:0 4px 14px rgba(0,0,0,.08)}
    .history .item.ok{background:#f0fdf4;border-color:var(--green)}
    .history .item.ko{background:#fef2f2;border-color:var(--red)}
    .nosleep{position:fixed;top:-9999px;left:-9999px;width:1px;height:1px;opacity:0}
    .loading{display:inline-block;width:22px;height:22px;border:3px solid #e5e7eb;border-top:3px solid var(--blue);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    @media (max-width:768px){.grid2{grid-template-columns:1fr} .quiz-header{flex-direction:column;align-items:stretch}}
    @media (prefers-color-scheme:dark){
      body{background:linear-gradient(135deg,#1e293b 0%,#334155 100%);color:#e5e7eb}
      .header,.card{background:rgba(17,24,39,.92)}
      .section{background:rgba(31,41,55,.88)}
      .qtext,.verset,.history .item{background:rgba(30,41,59,.95);color:#e5e7eb}
      select,input[type=number]{background:#0f172a;color:#f8fafc;border-color:#334155}
    }

/* Livre du Coran - Pages visuelles */
.quran-book {
  display: none;
  margin: 16px auto;
  background: linear-gradient(135deg, #8B4513 0%, #654321 100%);
  border-radius: 8px;
  padding: 20px;
  box-shadow: 0 10px 30px rgba(0,0,0,.3);
  max-width: 600px;
  position: relative;
}

.quran-book.show {
  display: block;
  animation: bookOpen 0.4s ease;
}

@keyframes bookOpen {
  from { opacity: 0; transform: scale(0.95); }
  to { opacity: 1; transform: scale(1); }
}

.book-pages {
  display: flex;
  gap: 4px;
  background: #2c1810;
  border-radius: 4px;
  padding: 4px;
  box-shadow: inset 0 2px 8px rgba(0,0,0,.4);
}

.book-page {
  flex: 1;
  background: #fffef7;
  border-radius: 4px;
  min-height: 180px;
  position: relative;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  box-shadow: 0 2px 8px rgba(0,0,0,.15);
  border: 2px solid #d4af37;
}

.book-page.empty {
  background: #f5f5dc;
  opacity: 0.4;
}

.book-page.left {
  border-right: 1px solid #d4af37;
}

.book-page.right {
  border-left: 1px solid #d4af37;
}

.page-number {
  font-family: 'Amiri', serif;
  font-size: 42px;
  font-weight: 700;
  color: #1e40af;
  text-shadow: 0 2px 4px rgba(0,0,0,.1);
  margin-bottom: 8px;
}

.page-lines {
  width: 80%;
  display: flex;
  flex-direction: column;
  gap: 8px;
  opacity: 0.3;
}

.page-line {
  height: 3px;
  background: linear-gradient(90deg, transparent, #666, transparent);
  border-radius: 2px;
}

.page-label {
  font-size: 12px;
  color: #64748b;
  font-weight: 600;
  margin-top: 8px;
}

.page-side-indicator {
  position: absolute;
  top: 8px;
  font-size: 11px;
  font-weight: 700;
  color: #1e40af;
  background: rgba(255,255,255,0.8);
  padding: 4px 8px;
  border-radius: 4px;
}

.book-page.left .page-side-indicator {
  left: 8px;
}

.book-page.right .page-side-indicator {
  right: 8px;
}

@media (max-width: 768px) {
  .quran-book {
    padding: 12px;
    max-width: 100%;
  }
  
  .book-page {
    min-height: 140px;
  }
  
  .page-number {
    font-size: 32px;
  }
  
  .page-lines {
    gap: 6px;
  }
}

/* Badge du numÃ©ro du verset - Ã€ L'EXTÃ‰RIEUR DU LIVRE */
.verse-number-badge {
  position: absolute;
  background: linear-gradient(135deg, #dc2626, #ef4444);
  color: white;
  font-family: 'Amiri', serif;
  font-size: 24px;
  font-weight: 700;
  padding: 12px 20px;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(220, 38, 38, 0.4);
  text-align: center;
  top: 50%;
  transform: translateY(-50%);
  white-space: nowrap;
  z-index: 100;
  opacity: 1 !important;
  display: block !important;
  width: max-content;
}

.verse-number-badge[data-position="left"] {
  left: -120px;
}

.verse-number-badge[data-position="right"] {
  right: -120px;
}

@media (max-width: 768px) {
  .verse-number-badge {
    font-size: 20px;
    padding: 10px 16px;
  }
  
  .verse-number-badge[data-position="left"] {
    left: -100px;
  }
  
  .verse-number-badge[data-position="right"] {
    right: -100px;
  }
}

/* Animation clignotante rouge pour les questions */
@keyframes blink-red {
  0%, 100% { 
    color: #1e40af;
    font-size: 1em;
    transform: scale(1);
  }
  50% { 
    color: #dc2626;
    font-size: 1.15em;
    transform: scale(1.05);
  }
}

.qtext.blink {
  animation: blink-red 0.6s ease-in-out 4;
}

  </style>
</head>
<body>
  <div class="app-container">
    <!-- Accueil -->
    <div id="home" class="page active">
      <div class="header">
        <h1>ğŸ•Œ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…</h1>
        <div class="subtitle">Quiz des Versets Coraniques - Ù…ØµØ­Ù Ø­ÙØµ 604 ØµÙØ­Ø©</div>
      </div>

      <div class="card">
        <div class="section">
          <h3>ØªØ­Ø¯ÙŠØ¯ Ù†Ø·Ø§Ù‚ Ø§Ù„Ø³ÙˆØ±</h3>
          <div class="grid2">
            <div class="group">
              <label>Ù…Ù† Ø§Ù„Ø³ÙˆØ±Ø©:</label>
              <select id="startSurah"></select>
            </div>
            <div class="group">
              <label>Ø¥Ù„Ù‰ Ø§Ù„Ø³ÙˆØ±Ø©:</label>
              <select id="endSurah"></select>
            </div>
          </div>
        </div>

        <div class="section">
          <h3>ØªØ­Ø¯ÙŠØ¯ Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¢ÙŠØ§Øª</h3>
          <div class="grid2">
            <div class="group">
              <label>Ù…Ù† Ø§Ù„Ø¢ÙŠØ©:</label>
              <input type="number" id="startVerse" min="1" value="1">
              <div id="startVerseErr" class="error"></div>
            </div>
            <div class="group">
              <label>Ø¥Ù„Ù‰ Ø§Ù„Ø¢ÙŠØ©:</label>
              <input type="number" id="endVerse" min="1" value="6">
              <div id="endVerseErr" class="error"></div>
            </div>
          </div>
        </div>

        <div class="section">
          <h3>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h3>
          <div class="grid2">
            <div class="group">
              <label>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª:</label>
              <select id="attempts">
                <option value="infinite">Ù„Ø§ Ù†Ù‡Ø§Ø¦ÙŠ</option>
                <option value="5">5 Ù…Ø­Ø§ÙˆÙ„Ø§Øª</option>
                <option value="10">10 Ù…Ø­Ø§ÙˆÙ„Ø§Øª</option>
                <option value="15">15 Ù…Ø­Ø§ÙˆÙ„Ø©</option>
                <option value="20">20 Ù…Ø­Ø§ÙˆÙ„Ø©</option>              
              </select>
            </div>
            <div class="group">
              <label>Ù†ÙˆØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:</label>
              <select id="mode">
                <option value="text">Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Øµ</option>
                <option value="audio">Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØµÙˆØª</option>
              </select>
            </div>
          </div>
        </div>

        <div class="section" id="reciterSection">
          <h3>Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø§Ø±Ø¦</h3>
          <select id="reciter"></select>
        </div>

        <div class="stats">
          Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¢ÙŠØ§Øª: <span id="totalVerses" class="highlight">0</span>
        </div>
        
         <div id="preloadSection" style="display:none;text-align:center;margin-bottom:16px;padding:12px;background:#e0f2fe;border-radius:8px">
        <div style="font-size:12px;color:#0369a1;margin-bottom:8px">ğŸ“¥ <strong>Mode Hors Ligne</strong></div>
        <button id="preloadBtn" class="btn btn-amber" style="width:100%">â¬‡ï¸ TÃ©lÃ©charger les audios (Option 2) </button>
       <div id="preloadProgress" style="font-size:11px;color:#0369a1;margin-top:6px;display:none">Chargement: <span id="preloadCount">0</span>/<span id="preloadTotal">0</span></div>
     </div>
        <button id="startBtn" class="btn btn-primary" style="width:100%">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</button>
      </div>
    </div>

    <!-- Quiz -->
    <div id="quiz" class="page">
      <div class="card">
        <div class="quiz-header">
          <div class="badges">
            <div class="badge">ØµØ­ÙŠØ­: <span id="ok" class="ok">0</span></div>
            <div class="badge">Ø®Ø·Ø£: <span id="ko" class="ko">0</span></div>
            <div class="badge">Ø§Ù„ÙˆÙ‚Øª: <span id="time">00:00:00</span></div>
            <div class="badge">Ø§Ù„Ø³Ø¤Ø§Ù„: <span><span id="cur">1</span> / <span id="tot">0</span></span></div>
          </div>
          <button id="homeBtn" class="btn btn-neutral">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        </div>

        <!-- Livre du Coran visuel -->
<div id="quranBook" class="quran-book">
  <div class="book-pages">
    <!-- Page de gauche (paire) -->
    <div id="leftPage" class="book-page left empty">
      <span class="page-side-indicator">Ø§Ù„ØµÙØ­Ø© Ø§Ù„ÙŠÙ…Ù†Ù‰</span>
      <div id="leftContent"></div>
    </div>
    
    <!-- Page de droite (impaire) -->
    <div id="rightPage" class="book-page right empty">
      <span class="page-side-indicator">Ø§Ù„ØµÙØ­Ø© Ø§Ù„ÙŠØ³Ø±Ù‰</span>
      <div id="rightContent"></div>
    </div>
  </div>
</div>

        <div class="qwrap">
          <div id="qCounter" class="qcounter"></div>

          <!-- Mode texte -->
          <div id="textMode">
            <div class="qtext">
              Ù…Ø§ Ù‡Ùˆ Ù†Øµ Ø§Ù„Ø¢ÙŠØ© Ø±Ù‚Ù… <span id="vNum" class="blue">1</span> Ù…Ù† Ø³ÙˆØ±Ø© <span id="sName" class="blue">Ø§Ù„ÙØ§ØªØ­Ø©</span>ØŸ
            </div>
            <div id="vText" class="verset" style="display:none"></div>
            <div class="controls">
              <button id="showBook" class="btn btn-amber">ğŸ“– Ø¹Ø±Ø¶ Ø§Ù„ØµÙØ­Ø©</button>
              <button id="showVerse" class="btn btn-primary">Ø¹Ø±Ø¶ Ø§Ù„Ù†Øµ</button>
              <div id="answersText" style="display:none;display:flex;gap:10px;flex-wrap:wrap;justify-content:center">
                <button id="okBtn1" class="btn btn-green">Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©</button>
                <button id="koBtn1" class="btn btn-red">Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©</button>
              </div>
              
            </div>
          </div>

          <!-- Mode audio -->
          <div id="audioMode" style="display:none">
            <div class="audio flex-audio">
            <audio id="player" controls></audio>
            <button id="replay" class="btn btn-amber">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ / ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª</button>
        </div>

            <div class="qtext">Ø­Ø¯Ø¯ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¢ÙŠØ© Ø§Ù„Ù…ØªÙ„ÙˆØ©:</div>
            <div id="info" class="verset" style="display:none;text-align:right">
              <div>Ø§Ù„Ù†Øµ: <span id="tAudio"></span></div>
              <div>Ø§Ù„Ø³ÙˆØ±Ø©: <span id="sAudio" class="blue"></span></div>
              <div>Ø±Ù‚Ù… Ø§Ù„Ø¢ÙŠØ©: <span id="nAudio" class="blue"></span></div>
              <div>Ø±Ù‚Ù… Ø§Ù„ØµÙØ­Ø©: <span id="pAudio" class="blue"></span></div>
              <div>Ø±Ù‚Ù… Ø§Ù„Ø¬Ø²Ø¡: <span id="jAudio" class="blue"></span></div>
            </div>
            <div class="controls">
              <button id="showBook" class="btn btn-amber">ğŸ“– Ø¹Ø±Ø¶ Ø§Ù„ØµÙØ­Ø©</button>
              <button id="showInfo" class="btn btn-primary">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</button>
              <div id="answersAudio" style="display:none;display:flex;gap:10px;flex-wrap:wrap;justify-content:center">
                <button id="okBtn2" class="btn btn-green">Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©</button>
                <button id="koBtn2" class="btn btn-red">Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©</button>
              </div>
              
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- RÃ©sultats -->
    <div id="results" class="page">
      <div class="card">
        <div class="quiz-header">
          <h3 style="color:var(--blue)">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h3>
          <button id="newQuiz" class="btn btn-neutral">Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ø¯ÙŠØ¯</button>
        </div>
        <div class="grid2">
          <div class="card" style="margin:0">
            <div class="badges" style="gap:14px">
              <div class="badge" style="background:linear-gradient(135deg,#059669,#10b981);color:#fff">
                <div style="font-size:26px;font-weight:800" id="fOk">0</div>Ø¥Ø¬Ø§Ø¨Ø§Øª ØµØ­ÙŠØ­Ø©
              </div>
              <div class="badge" style="background:linear-gradient(135deg,#dc2626,#ef4444);color:#fff">
                <div style="font-size:26px;font-weight:800" id="fKo">0</div>Ø¥Ø¬Ø§Ø¨Ø§Øª Ø®Ø§Ø·Ø¦Ø©
              </div>
              <div class="badge" style="background:linear-gradient(135deg,#1e40af,#3b82f6);color:#fff">
                <div style="font-size:26px;font-weight:800" id="fTime">00:00:00</div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙˆÙ‚Øª
              </div>
            </div>
            <div style="text-align:center;margin-top:10px;color:#64748b">
              <div>Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: <span id="tStart"></span></div>
              <div>Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: <span id="tEnd"></span></div>
              <div>Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©: <span id="pct" class="highlight">0%</span></div>
            </div>
          </div>
          <div class="card history" style="margin:0">
            <h3 style="color:var(--blue);text-align:center;margin-bottom:10px">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª</h3>
            <div id="hist"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- VidÃ©o anti-sommeil (muted, inline) -->
  <video id="nosleep" class="nosleep" muted playsinline loop>
    <source type="video/mp4" src="data:video/mp4;base64,AAAAHGZ0eXBNNFYgAAACAGlzb21pc28yYXZjMQAAAAhmcmVlAAAGF21kYXTeBAAAbGliZmFhYyAxLjI4AABCAJMgBDIARIiIQIiIgAAAAlBmBQ==">
  </video>

  <script>
    // DonnÃ©es sourates (num + nom arabe + nb versets)
    const SOURATES = [
      {num:1, nom:"Ø§Ù„ÙØ§ØªØ­Ø©", versets:7},{num:2, nom:"Ø§Ù„Ø¨Ù‚Ø±Ø©", versets:286},{num:3, nom:"Ø¢Ù„ Ø¹Ù…Ø±Ø§Ù†", versets:200},
      {num:4, nom:"Ø§Ù„Ù†Ø³Ø§Ø¡", versets:176},{num:5, nom:"Ø§Ù„Ù…Ø§Ø¦Ø¯Ø©", versets:120},{num:6, nom:"Ø§Ù„Ø£Ù†Ø¹Ø§Ù…", versets:165},
      {num:7, nom:"Ø§Ù„Ø£Ø¹Ø±Ø§Ù", versets:206},{num:8, nom:"Ø§Ù„Ø£Ù†ÙØ§Ù„", versets:75},{num:9, nom:"Ø§Ù„ØªÙˆØ¨Ø©", versets:129},
      {num:10, nom:"ÙŠÙˆÙ†Ø³", versets:109},{num:11, nom:"Ù‡ÙˆØ¯", versets:123},{num:12, nom:"ÙŠÙˆØ³Ù", versets:111},
      {num:13, nom:"Ø§Ù„Ø±Ø¹Ø¯", versets:43},{num:14, nom:"Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…", versets:52},{num:15, nom:"Ø§Ù„Ø­Ø¬Ø±", versets:99},
      {num:16, nom:"Ø§Ù„Ù†Ø­Ù„", versets:128},{num:17, nom:"Ø§Ù„Ø¥Ø³Ø±Ø§Ø¡", versets:111},{num:18, nom:"Ø§Ù„ÙƒÙ‡Ù", versets:110},
      {num:19, nom:"Ù…Ø±ÙŠÙ…", versets:98},{num:20, nom:"Ø·Ù‡", versets:135},{num:21, nom:"Ø§Ù„Ø£Ù†Ø¨ÙŠØ§Ø¡", versets:112},
      {num:22, nom:"Ø§Ù„Ø­Ø¬", versets:78},{num:23, nom:"Ø§Ù„Ù…Ø¤Ù…Ù†ÙˆÙ†", versets:118},{num:24, nom:"Ø§Ù„Ù†ÙˆØ±", versets:64},
      {num:25, nom:"Ø§Ù„ÙØ±Ù‚Ø§Ù†", versets:77},{num:26, nom:"Ø§Ù„Ø´Ø¹Ø±Ø§Ø¡", versets:227},{num:27, nom:"Ø§Ù„Ù†Ù…Ù„", versets:93},
      {num:28, nom:"Ø§Ù„Ù‚ØµØµ", versets:88},{num:29, nom:"Ø§Ù„Ø¹Ù†ÙƒØ¨ÙˆØª", versets:69},{num:30, nom:"Ø§Ù„Ø±ÙˆÙ…", versets:60},
      {num:31, nom:"Ù„Ù‚Ù…Ø§Ù†", versets:34},{num:32, nom:"Ø§Ù„Ø³Ø¬Ø¯Ø©", versets:30},{num:33, nom:"Ø§Ù„Ø£Ø­Ø²Ø§Ø¨", versets:73},
      {num:34, nom:"Ø³Ø¨Ø£", versets:54},{num:35, nom:"ÙØ§Ø·Ø±", versets:45},{num:36, nom:"ÙŠØ³", versets:83},
      {num:37, nom:"Ø§Ù„ØµØ§ÙØ§Øª", versets:182},{num:38, nom:"Øµ", versets:88},{num:39, nom:"Ø§Ù„Ø²Ù…Ø±", versets:75},
      {num:40, nom:"ØºØ§ÙØ±", versets:85},{num:41, nom:"ÙØµÙ„Øª", versets:54},{num:42, nom:"Ø§Ù„Ø´ÙˆØ±Ù‰", versets:53},
      {num:43, nom:"Ø§Ù„Ø²Ø®Ø±Ù", versets:89},{num:44, nom:"Ø§Ù„Ø¯Ø®Ø§Ù†", versets:59},{num:45, nom:"Ø§Ù„Ø¬Ø§Ø«ÙŠØ©", versets:37},
      {num:46, nom:"Ø§Ù„Ø£Ø­Ù‚Ø§Ù", versets:35},{num:47, nom:"Ù…Ø­Ù…Ø¯", versets:38},{num:48, nom:"Ø§Ù„ÙØªØ­", versets:29},
      {num:49, nom:"Ø§Ù„Ø­Ø¬Ø±Ø§Øª", versets:18},{num:50, nom:"Ù‚", versets:45},{num:51, nom:"Ø§Ù„Ø°Ø§Ø±ÙŠØ§Øª", versets:60},
      {num:52, nom:"Ø§Ù„Ø·ÙˆØ±", versets:49},{num:53, nom:"Ø§Ù„Ù†Ø¬Ù…", versets:62},{num:54, nom:"Ø§Ù„Ù‚Ù…Ø±", versets:55},
      {num:55, nom:"Ø§Ù„Ø±Ø­Ù…Ù†", versets:78},{num:56, nom:"Ø§Ù„ÙˆØ§Ù‚Ø¹Ø©", versets:96},{num:57, nom:"Ø§Ù„Ø­Ø¯ÙŠØ¯", versets:29},
      {num:58, nom:"Ø§Ù„Ù…Ø¬Ø§Ø¯Ù„Ø©", versets:22},{num:59, nom:"Ø§Ù„Ø­Ø´Ø±", versets:24},{num:60, nom:"Ø§Ù„Ù…Ù…ØªØ­Ù†Ø©", versets:13},
      {num:61, nom:"Ø§Ù„ØµÙ", versets:14},{num:62, nom:"Ø§Ù„Ø¬Ù…Ø¹Ø©", versets:11},{num:63, nom:"Ø§Ù„Ù…Ù†Ø§ÙÙ‚ÙˆÙ†", versets:11},
      {num:64, nom:"Ø§Ù„ØªØºØ§Ø¨Ù†", versets:18},{num:65, nom:"Ø§Ù„Ø·Ù„Ø§Ù‚", versets:12},{num:66, nom:"Ø§Ù„ØªØ­Ø±ÙŠÙ…", versets:12},
      {num:67, nom:"Ø§Ù„Ù…Ù„Ùƒ", versets:30},{num:68, nom:"Ø§Ù„Ù‚Ù„Ù…", versets:52},{num:69, nom:"Ø§Ù„Ø­Ø§Ù‚Ø©", versets:52},
      {num:70, nom:"Ø§Ù„Ù…Ø¹Ø§Ø±Ø¬", versets:44},{num:71, nom:"Ù†ÙˆØ­", versets:28},{num:72, nom:"Ø§Ù„Ø¬Ù†", versets:28},
      {num:73, nom:"Ø§Ù„Ù…Ø²Ù…Ù„", versets:20},{num:74, nom:"Ø§Ù„Ù…Ø¯Ø«Ø±", versets:56},{num:75, nom:"Ø§Ù„Ù‚ÙŠØ§Ù…Ø©", versets:40},
      {num:76, nom:"Ø§Ù„Ø¥Ù†Ø³Ø§Ù†", versets:31},{num:77, nom:"Ø§Ù„Ù…Ø±Ø³Ù„Ø§Øª", versets:50},{num:78, nom:"Ø§Ù„Ù†Ø¨Ø£", versets:40},
      {num:79, nom:"Ø§Ù„Ù†Ø§Ø²Ø¹Ø§Øª", versets:46},{num:80, nom:"Ø¹Ø¨Ø³", versets:42},{num:81, nom:"Ø§Ù„ØªÙƒÙˆÙŠØ±", versets:29},
      {num:82, nom:"Ø§Ù„Ø§Ù†ÙØ·Ø§Ø±", versets:19},{num:83, nom:"Ø§Ù„Ù…Ø·ÙÙÙŠÙ†", versets:36},{num:84, nom:"Ø§Ù„Ø§Ù†Ø´Ù‚Ø§Ù‚", versets:25},
      {num:85, nom:"Ø§Ù„Ø¨Ø±ÙˆØ¬", versets:22},{num:86, nom:"Ø§Ù„Ø·Ø§Ø±Ù‚", versets:17},{num:87, nom:"Ø§Ù„Ø£Ø¹Ù„Ù‰", versets:19},
      {num:88, nom:"Ø§Ù„ØºØ§Ø´ÙŠØ©", versets:26},{num:89, nom:"Ø§Ù„ÙØ¬Ø±", versets:30},{num:90, nom:"Ø§Ù„Ø¨Ù„Ø¯", versets:20},
      {num:91, nom:"Ø§Ù„Ø´Ù…Ø³", versets:15},{num:92, nom:"Ø§Ù„Ù„ÙŠÙ„", versets:21},{num:93, nom:"Ø§Ù„Ø¶Ø­Ù‰", versets:11},
      {num:94, nom:"Ø§Ù„Ø´Ø±Ø­", versets:8},{num:95, nom:"Ø§Ù„ØªÙŠÙ†", versets:8},{num:96, nom:"Ø§Ù„Ø¹Ù„Ù‚", versets:19},
      {num:97, nom:"Ø§Ù„Ù‚Ø¯Ø±", versets:5},{num:98, nom:"Ø§Ù„Ø¨ÙŠÙ†Ø©", versets:8},{num:99, nom:"Ø§Ù„Ø²Ù„Ø²Ù„Ø©", versets:8},
      {num:100, nom:"Ø§Ù„Ø¹Ø§Ø¯ÙŠØ§Øª", versets:11},{num:101, nom:"Ø§Ù„Ù‚Ø§Ø±Ø¹Ø©", versets:11},{num:102, nom:"Ø§Ù„ØªÙƒØ§Ø«Ø±", versets:8},
      {num:103, nom:"Ø§Ù„Ø¹ØµØ±", versets:3},{num:104, nom:"Ø§Ù„Ù‡Ù…Ø²Ø©", versets:9},{num:105, nom:"Ø§Ù„ÙÙŠÙ„", versets:5},
      {num:106, nom:"Ù‚Ø±ÙŠØ´", versets:4},{num:107, nom:"Ø§Ù„Ù…Ø§Ø¹ÙˆÙ†", versets:7},{num:108, nom:"Ø§Ù„ÙƒÙˆØ«Ø±", versets:3},
      {num:109, nom:"Ø§Ù„ÙƒØ§ÙØ±ÙˆÙ†", versets:6},{num:110, nom:"Ø§Ù„Ù†ØµØ±", versets:3},{num:111, nom:"Ø§Ù„Ù…Ø³Ø¯", versets:5},
      {num:112, nom:"Ø§Ù„Ø¥Ø®Ù„Ø§Øµ", versets:4},{num:113, nom:"Ø§Ù„ÙÙ„Ù‚", versets:5},{num:114, nom:"Ø§Ù„Ù†Ø§Ø³", versets:6}
    ];

    const RECITERS = [
  {id:"alafasy", name:"Ù…Ø´Ø§Ø±ÙŠ Ø±Ø§Ø´Ø¯ Ø§Ù„Ø¹ÙØ§Ø³ÙŠ", path:"Alafasy_128kbps"},
  {id:"shatri", name:"Ø£Ø¨Ùˆ Ø¨ÙƒØ± Ø§Ù„Ø´Ø§Ø·Ø±ÙŠ", path:"Abu_Bakr_Ash-Shaatree_128kbps"},
  {id:"hudhaify", name:"Ø¹Ù„ÙŠ Ø§Ù„Ø­Ø°ÙŠÙÙŠ", path:"Hudhaify_128kbps"},
  {id:"husary", name:"Ù…Ø­Ù…ÙˆØ¯ Ø®Ù„ÙŠÙ„ Ø§Ù„Ø­ØµØ±ÙŠ", path:"Husary_128kbps"},
  {id:"minshawi", name:"Ù…Ø­Ù…Ø¯ ØµØ¯ÙŠÙ‚ Ø§Ù„Ù…Ù†Ø´Ø§ÙˆÙŠ", path:"Minshawi_Mujawwad_128kbps"},
  {id:"muaiqly", name:"Ù…Ø§Ù‡Ø± Ø§Ù„Ù…Ø¹ÙŠÙ‚Ù„ÙŠ", path:"Maher_AlMuaiqly_64kbps"},
  {id:"ghamdi", name:"Ø³Ø¹Ø¯ Ø§Ù„ØºØ§Ù…Ø¯ÙŠ", path:"Ghamadi_40kbps"},
  {id:"sudais", name:"Ø¹Ø¨Ø¯ Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ø³Ø¯ÙŠØ³", path:"Abdurrahmaan_As-Sudais_192kbps"}
];

    // Elements
    const E = {
      pages:{home:byId('home'),quiz:byId('quiz'),results:byId('results')},
      startSurah:byId('startSurah'),endSurah:byId('endSurah'),
      startVerse:byId('startVerse'),endVerse:byId('endVerse'),
      startVerseErr:byId('startVerseErr'),endVerseErr:byId('endVerseErr'),
      attempts:byId('attempts'),mode:byId('mode'),reciter:byId('reciter'),reciterSection:byId('reciterSection'),
      totalVerses:byId('totalVerses'),startBtn:byId('startBtn'),
      homeBtn:byId('homeBtn'),ok:byId('ok'),ko:byId('ko'),time:byId('time'),cur:byId('cur'),tot:byId('tot'),
      vNum:byId('vNum'),sName:byId('sName'),vText:byId('vText'),showVerse:byId('showVerse'),
      answersText:byId('answersText'),okBtn1:byId('okBtn1'),koBtn1:byId('koBtn1'),next1:byId('next1'),
      player:byId('player'),replay:byId('replay'),showInfo:byId('showInfo'),
      info:byId('info'),tAudio:byId('tAudio'),sAudio:byId('sAudio'),nAudio:byId('nAudio'),pAudio:byId('pAudio'),jAudio:byId('jAudio'),
      answersAudio:byId('answersAudio'),okBtn2:byId('okBtn2'),koBtn2:byId('koBtn2'),next2:byId('next2'),
      fOk:byId('fOk'),fKo:byId('fKo'),fTime:byId('fTime'),tStart:byId('tStart'),tEnd:byId('tEnd'),pct:byId('pct'),hist:byId('hist'),
    
quranBook:byId('quranBook'),
leftPage:byId('leftPage'),
rightPage:byId('rightPage'),
leftContent:byId('leftContent'),
rightContent:byId('rightContent'),
  newQuiz:byId('newQuiz'),nosleep:byId('nosleep'),qCounter:byId('qCounter'),textMode:byId('textMode'),audioMode:byId('audioMode')
    };
    function byId(id){return document.getElementById(id)}

    // Ã‰tat
    let state = {
      startTime:null,endTime:null,activeMs:0,lastTick:null,active:true,timer:null,
      ok:0,ko:0,questions:[],idx:0,mode:"text",reciter:"hudhaify",history:[]
    };

    // Wake Lock pour empÃªcher la mise en veille
    let wakeLock = null;

    async function requestWakeLock() {
    try {
    if ('wakeLock' in navigator) {
      wakeLock = await navigator.wakeLock.request('screen');
      console.log('Wake Lock activÃ©');
      }
    } catch (err) {
      console.error('Wake Lock Ã©chouÃ©:', err);
    }
  }

  function releaseWakeLock() {
    if (wakeLock !== null) {
      wakeLock.release().then(() => {
        wakeLock = null;
        console.log('Wake Lock dÃ©sactivÃ©');
      });
    }
  }

// Charger les versets depuis le fichier JSON local
let versesData = null;

async function loadVersesData() {
  try {
    const response = await fetch('./data/verses.json');
    versesData = await response.json();
    console.log('âœ… Versets chargÃ©s:', Object.keys(versesData).length, 'versets');
  } catch (e) {
    console.error('âŒ Erreur lors du chargement des versets:', e);
  }
}

// Charger les versets dÃ¨s le dÃ©marrage
loadVersesData();

    // Init
    document.addEventListener('DOMContentLoaded', () => {
      initSelectors();
      bindEvents();
      updateTotals();
      toggleReciter();
  
   // Wake Lock : rÃ©activer quand l'utilisateur revient sur l'app
      document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible' && state.timer !== null) {
          requestWakeLock();
        }
      });
  
   // Anti-sommeil vidÃ©o (fallback pour navigateurs sans Wake Lock)
      const arm = () => E.nosleep.play().catch(()=>{});
      document.addEventListener('click', arm, {once:true});
      document.addEventListener('touchstart', arm, {once:true});
  
   // Service Worker inline
      registerSW();
  
   // Restaurer l'Ã©tat si l'utilisateur revient aprÃ¨s avoir quittÃ© l'app
      restoreQuizIfNeeded();
    });

    function initSelectors(){
      // remplir sourates
      for(const s of SOURATES){
        const opt1=document.createElement('option'); opt1.value=s.num; opt1.textContent=`${s.num}. ${s.nom}`; E.startSurah.appendChild(opt1);
        const opt2=document.createElement('option'); opt2.value=s.num; opt2.textContent=`${s.num}. ${s.nom}`; E.endSurah.appendChild(opt2);
      }
      E.startSurah.value="1"; E.endSurah.value="114";
      E.startVerse.value="1"; setEndMax();
      // rÃ©citateur
      for(const r of RECITERS){const o=document.createElement('option');o.value=r.id;o.textContent=`${r.name}`;E.reciter.appendChild(o)}
      E.reciter.value="hudhaify";
    }

     // PrÃ©-charger les audios
async function preloadAudios() {
  const a = parseInt(E.startSurah.value), b = parseInt(E.endSurah.value);
  const va = parseInt(E.startVerse.value||"1"), vb = parseInt(E.endVerse.value||"1");
  const reciterId = E.reciter.value;
  const r = RECITERS.find(x=>x.id===reciterId) || RECITERS[0];
  
  const preloadBtn = document.getElementById('preloadBtn');
  const preloadProgress = document.getElementById('preloadProgress');
  const preloadCount = document.getElementById('preloadCount');
  const preloadTotal = document.getElementById('preloadTotal');
  
  const audiosToLoad = [];
  for(let s=a; s<=b; s++){
    const S = getSurah(s);
    const from = (s===a) ? va : 1;
    const to = (s===b) ? Math.min(vb, S.versets) : S.versets;
    for(let v=from; v<=to; v++){
      const ss = String(s).padStart(3,'0');
      const vv = String(v).padStart(3,'0');
      audiosToLoad.push(`./audios/${r.path}/${ss}${vv}.mp3`);
    }
  }
  
  preloadTotal.textContent = audiosToLoad.length;
  preloadProgress.style.display = 'block';
  preloadBtn.disabled = true;
  preloadBtn.textContent = 'â³ Chargement...';
  
  let loaded = 0;
  const cache = await caches.open('quiz-coran-v1');
  
  for(const url of audiosToLoad){
    try {
      const response = await fetch(url);
      if(response.ok) {
        await cache.put(url, response.clone());
        console.log('ğŸ’¾ Cached:', url);
      }
      loaded++;
      preloadCount.textContent = loaded;
    } catch(e){
      console.warn('âš ï¸ Erreur:', url, e.message);
      loaded++;
      preloadCount.textContent = loaded;
    }
  }
  
  preloadBtn.disabled = false;
  preloadBtn.textContent = 'âœ… ' + loaded + ' audios chargÃ©s !';
  console.log('âœ… Tous les audios sont en cache !');
  setTimeout(()=>{ preloadBtn.textContent = 'â¬‡ï¸ TÃ©lÃ©charger les audios (Option 2)'; }, 3000);
}

    function bindEvents(){
  // Premier filtre SOURATES : change endSurah si startSurah > endSurah ET rÃ©initialise versets
  E.startSurah.addEventListener('change', ()=>{
    clearQuizState();
    const startVal = parseInt(E.startSurah.value);
    const endVal = parseInt(E.endSurah.value);
    
    // Si startSurah > endSurah, change endSurah
    if(startVal > endVal) {
      E.endSurah.value = startVal;
      setEndMax();
    }
    
    // RÃ©initialise les versets : startVerse = 1
    E.startVerse.value = "1";
    
    // Si mÃªme sourate, limiter endVerse au max de cette sourate
    if(startVal === endVal) {
      const s = getSurah(startVal);
      E.endVerse.value = s.versets;
      E.endVerse.max = s.versets;
    } else {
      setEndMax();
    }
    
    validateStart();
    updateTotals();
  });

  // DeuxiÃ¨me filtre SOURATES : change startSurah si endSurah < startSurah
  E.endSurah.addEventListener('change', ()=>{
    clearQuizState();
    const endVal = parseInt(E.endSurah.value);
    const startVal = parseInt(E.startSurah.value);
    
    if(endVal < startVal) {
      E.startSurah.value = endVal;
      E.startVerse.value = "1";
    }
    
    setEndMax();
    validateEnd();
    updateTotals();
  });

  E.startVerse.addEventListener('input', ()=>{
  clearQuizState();
  const startSurah = parseInt(E.startSurah.value);
  const endSurah = parseInt(E.endSurah.value);
  
  if(startSurah === endSurah) {
    const startVerseVal = parseInt(E.startVerse.value||"1");
    const endVerseVal = parseInt(E.endVerse.value||"1");
    
    if(startVerseVal > endVerseVal) {
      alert(`âš ï¸ Ø±Ù‚Ù… Ø§Ù„Ø¢ÙŠØ© Ø§Ù„Ø£ÙˆÙ„Ù‰ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£Ù‚Ù„ Ù…Ù† Ø£Ùˆ ÙŠØ³Ø§ÙˆÙŠ Ø±Ù‚Ù… Ø§Ù„Ø¢ÙŠØ© Ø§Ù„Ø£Ø®ÙŠØ±Ø© (${endVerseVal}) !\nØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†Ù‡ Ø¥Ù„Ù‰ 1`);
      E.startVerse.value = "1";
    }
  }
  
  validateStart();
  updateTotals();
});

  E.endVerse.addEventListener('input', ()=>{
  clearQuizState();
  const startSurah = parseInt(E.startSurah.value);
  const endSurah = parseInt(E.endSurah.value);
  
  if(startSurah === endSurah) {
    const startVerseVal = parseInt(E.startVerse.value||"1");
    const endVerseVal = parseInt(E.endVerse.value||"1");
    
    if(startVerseVal > endVerseVal) {
      // alert(`âš ï¸ Ø±Ù‚Ù… Ø§Ù„Ø¢ÙŠØ© Ø§Ù„Ø£Ø®ÙŠØ±Ø© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ù…Ù† Ø£Ùˆ ÙŠØ³Ø§ÙˆÙŠ Ø±Ù‚Ù… Ø§Ù„Ø¢ÙŠØ© Ø§Ù„Ø£ÙˆÙ„Ù‰ (${startVerseVal})\nØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¢ÙŠØ© Ø§Ù„Ø£ÙˆÙ„Ù‰ Ø¥Ù„Ù‰ 1`);
      E.startVerse.value = "1";
    }
  }
  
  validateEnd();
  updateTotals();
});

  E.mode.addEventListener('change', ()=>{
    clearQuizState();
    toggleReciter();
    const preloadSection = document.getElementById('preloadSection');
    preloadSection.style.display = E.mode.value === 'audio' ? 'block' : 'none';
  });
  E.attempts.addEventListener('change', ()=>{clearQuizState()});
  E.reciter.addEventListener('change', ()=>{clearQuizState()});

  E.startBtn.addEventListener('click', startQuiz);
  E.homeBtn.addEventListener('click', () => goto('home'));
  E.newQuiz.addEventListener('click', () => goto('home'));

  // texte
  E.showVerse.addEventListener('click', showVerseText);
  E.okBtn1.addEventListener('click', ()=>record(true));
  E.koBtn1.addEventListener('click', ()=>record(false));

  // audio
  E.replay.addEventListener('click', ()=>{E.player.currentTime=0;E.player.play().catch(()=>{})});
  E.showInfo.addEventListener('click', showAudioInfo);
  E.okBtn2.addEventListener('click', ()=>record(true));
  E.koBtn2.addEventListener('click', ()=>record(false));

  // PrÃ©-chargement
  document.getElementById('preloadBtn').addEventListener('click', preloadAudios);

  // Afficher le livre avant la rÃ©ponse
  const showBookBtns = document.querySelectorAll('#showBook');
  showBookBtns.forEach(btn => {
    btn.addEventListener('click', showBook);
  });

  // visibility â†’ pause
  document.addEventListener('visibilitychange', ()=>{if(document.hidden) pauseTimer(); else resumeTimer();});
  window.addEventListener('blur', pauseTimer);
  window.addEventListener('focus', resumeTimer);
}

    function toggleReciter(){
      const isAudio = E.mode.value==="audio";
      E.reciterSection.style.display = isAudio ? 'block' : 'none';
    }

    function setEndMax(){
      const endS = getSurah(parseInt(E.endSurah.value));
      E.endVerse.max = endS.versets; E.endVerse.value=endS.versets;
    }
    function validateStart(){
      const s = getSurah(parseInt(E.startSurah.value));
      let v = parseInt(E.startVerse.value||"1");
      if(v> s.versets){E.startVerse.value=s.versets; showErr(E.startVerseErr, `Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø¢ÙŠØ§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø³ÙˆØ±Ø© Ù‡Ùˆ ${s.versets}`)}
      else if(v<1){E.startVerse.value=1; hideErr(E.startVerseErr)}
      else hideErr(E.startVerseErr);
    }
    function validateEnd(){
      const s = getSurah(parseInt(E.endSurah.value));
      let v = parseInt(E.endVerse.value||"1");
      if(v> s.versets){E.endVerse.value=s.versets; showErr(E.endVerseErr, `Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø¢ÙŠØ§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø³ÙˆØ±Ø© Ù‡Ùˆ ${s.versets}`)}
      else if(v<1){E.endVerse.value=1; hideErr(E.endVerseErr)}
      else hideErr(E.endVerseErr);
    }
    function showErr(el, msg){el.textContent=msg; el.classList.add('show')}
    function hideErr(el){el.classList.remove('show')}

    function updateTotals(){
      const a=parseInt(E.startSurah.value), b=parseInt(E.endSurah.value);
      const va=parseInt(E.startVerse.value||"1"), vb=parseInt(E.endVerse.value||"1");
      if(a>b){E.totalVerses.textContent="0";return}
      let total=0;
      for(let i=a;i<=b;i++){
        const s=getSurah(i);
        if(i===a && i===b) total += Math.max(0, vb - va + 1);
        else if(i===a) total += Math.max(0, s.versets - va + 1);
        else if(i===b) total += Math.max(0, vb);
        else total += s.versets;
      }
      E.totalVerses.textContent = total;
    }

    function getSurah(n){return SOURATES.find(x=>x.num===n)}

    function startQuiz(){
      // validations
      const a=parseInt(E.startSurah.value), b=parseInt(E.endSurah.value);
      const va=parseInt(E.startVerse.value||"1"), vb=parseInt(E.endVerse.value||"1");
      if(a>b){return alert("Ø§Ù„Ø³ÙˆØ±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ù‚Ø¨Ù„ Ø§Ù„Ø³ÙˆØ±Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø©")}
      if(a===b && va>vb){return alert("Ø±Ù‚Ù… Ø§Ù„Ø¢ÙŠØ© Ø§Ù„Ø£ÙˆÙ„Ù‰ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù‚Ø¨Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¢ÙŠØ© Ø§Ù„Ø£Ø®ÙŠØ±Ø©")}
      if(parseInt(E.totalVerses.textContent)===0){return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¢ÙŠØ§Øª ÙÙŠ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ù…Ø­Ø¯Ø¯")}
      // Ã©tat
      state = {
        startTime:new Date(), endTime:null, activeMs:0, lastTick:Date.now(), active:true, timer:null,
        ok:0, ko:0, questions:[], idx:0, mode:E.mode.value, reciter:E.reciter.value, history:[]
      };
      // gÃ©nÃ©rer questions uniques
      const qs=[];
      for(let s=a;s<=b;s++){
        const S=getSurah(s);
        const from = (s===a) ? va : 1;
        const to   = (s===b) ? Math.min(vb,S.versets) : S.versets;
        for(let v=from;v<=to;v++){
          qs.push({surah:s, verse:v, name:S.nom});
        }
      }
      shuffle(qs);
      // limiter par tentatives sauf infini
      const att = E.attempts.value==="infinite" ? qs.length : Math.min(parseInt(E.attempts.value), qs.length);
      state.questions = qs.slice(0, att);
      // UI
      E.tot.textContent = state.questions.length; E.cur.textContent="1";
      E.ok.textContent="0"; E.ko.textContent="0"; E.time.textContent="00:00:00";
      goto('quiz');
      startTimer();
      showQuestion();
      requestWakeLock();    // Activer Wake Lock au dÃ©but du quiz
      saveQuizState();      // Sauvegarder l'Ã©tat initial
    }

    function shuffle(arr){for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]]}return arr}

    function goto(id){
    for(const k of Object.keys(E.pages)) E.pages[k].classList.remove('active');
    E.pages[id].classList.add('active');
    if(id==='home'){
      stopTimer();
      clearQuizState();  // Nettoyer quand on retourne Ã  l'accueil
      hideQuranBook();
    }
  }

    function startTimer(){
      stopTimer();
      state.lastTick = Date.now(); state.active=true;
      state.timer = setInterval(()=>{
        if(!state.active) return;
        const now=Date.now(); state.activeMs += (now-state.lastTick); state.lastTick=now;
        E.time.textContent = fmtMs(state.activeMs);
      }, 1000);
    }
    function pauseTimer(){ if(state.active){ state.active=false; } }
    function resumeTimer(){ if(!state.active){ state.lastTick = Date.now(); state.active=true; } }
    function stopTimer(){ if(state.timer){ clearInterval(state.timer); state.timer=null; } }
    
    // Sauvegarder l'Ã©tat du quiz
    function saveQuizState() {
      if (state.questions.length > 0) {
        const toSave = {
          ...state,
          startTime: state.startTime ? state.startTime.toISOString() : null,
          endTime: state.endTime ? state.endTime.toISOString() : null,
          history: state.history.map(h => ({
            ...h,
            at: h.at.toISOString()
          }))
        };
        sessionStorage.setItem('quizState', JSON.stringify(toSave));
      }
    }

   // Restaurer l'Ã©tat du quiz
    function restoreQuizIfNeeded() {
      const saved = sessionStorage.getItem('quizState');
      if (!saved) return;
  
      try {
        const restored = JSON.parse(saved);
    
    // Restaurer l'Ã©tat
    state = {
      ...restored,
      startTime: restored.startTime ? new Date(restored.startTime) : null,
      endTime: restored.endTime ? new Date(restored.endTime) : null,
      history: restored.history.map(h => ({
        ...h,
        at: new Date(h.at)
      })),
      timer: null  // Le timer sera redÃ©marrÃ©
    };
    
    // Restaurer l'UI
        E.tot.textContent = state.questions.length;
        E.cur.textContent = (state.idx + 1).toString();
        E.ok.textContent = state.ok.toString();
        E.ko.textContent = state.ko.toString();
        E.time.textContent = fmtMs(state.activeMs);
    
    // Afficher la page quiz
        goto('quiz');
        startTimer();
        showQuestion();
        requestWakeLock();
    
        console.log('Quiz restaurÃ© avec succÃ¨s');
      } catch (e) {
        console.error('Erreur de restauration:', e);
        sessionStorage.removeItem('quizState');
      }
    }

   // Effacer la sauvegarde
    function clearQuizState() {
      sessionStorage.removeItem('quizState');
      releaseWakeLock();
    }

    function fmtMs(ms){
      const s=Math.floor(ms/1000);
      const h=String(Math.floor(s/3600)).padStart(2,'0');
      const m=String(Math.floor((s%3600)/60)).padStart(2,'0');
      const ss=String(s%60).padStart(2,'0');
      return `${h}:${m}:${ss}`;
    }

    function showQuranBook(pageNum, verseNum) {
  if (!pageNum || pageNum < 1 || pageNum > 604) {
    E.quranBook.classList.remove('show');
    return;
  }
  
  const isOdd = pageNum % 2 !== 0; // impair = droite dans le Coran
  
  // RÃ©initialiser
  E.leftPage.classList.add('empty');
  E.rightPage.classList.add('empty');
  E.leftContent.innerHTML = '';
  E.rightContent.innerHTML = '';
  
  // Enlever ancien badge s'il existe
  const oldBadge = E.quranBook.querySelector('.verse-number-badge');
  if (oldBadge) oldBadge.remove();
  
  if (isOdd) {
    // Page impaire â†’ DROITE (mais dans HTML c'est LEFT Ã  cause du RTL!)
    E.leftPage.classList.remove('empty');  
    E.leftContent.innerHTML = `            
      <div class="page-number">${pageNum}</div>
      <div class="page-lines">
        <div class="page-line"></div>
        <div class="page-line"></div>
        <div class="page-line"></div>
        <div class="page-line"></div>
        <div class="page-line"></div>
      </div>
      <div class="page-label">ØµÙØ­Ø© ${pageNum}</div>
    `;
  } else {
    // Page paire â†’ GAUCHE (mais dans HTML c'est RIGHT Ã  cause du RTL!)
    E.rightPage.classList.remove('empty'); 
    E.rightContent.innerHTML = `           
      <div class="page-number">${pageNum}</div>
      <div class="page-lines">
        <div class="page-line"></div>
        <div class="page-line"></div>
        <div class="page-line"></div>
        <div class="page-line"></div>
        <div class="page-line"></div>
      </div>
      <div class="page-label">ØµÙØ­Ø© ${pageNum}</div>
    `;
  }
  
  // Ajouter le badge du verset Ã  l'extÃ©rieur
  if (verseNum) {
    const badge = document.createElement('div');
    badge.className = 'verse-number-badge';
    badge.setAttribute('data-position', isOdd ? 'right' : 'left');
    badge.textContent = verseNum;
    E.quranBook.appendChild(badge);
  }
  
  E.quranBook.classList.add('show');
}

function hideQuranBook() {
  E.quranBook.classList.remove('show');
}

    function showQuestion(){
    // hideQuranBook(); // NE PAS cacher le livre ici
      if(state.idx>=state.questions.length){ return endQuiz(); }
      const q=state.questions[state.idx];
      E.cur.textContent = (state.idx+1).toString();

      // === Animation CLIGNOTEMENT question ===
      if(state.mode==="text"){
        const questionElem = E.textMode.querySelector('.qtext');
        if (questionElem) {
          questionElem.classList.remove('blink');
          void questionElem.offsetWidth;
          questionElem.classList.add('blink');
        }
      } else {
        const questionElem = E.audioMode.querySelector('.qtext');
        if (questionElem) {
          questionElem.classList.remove('blink');
          void questionElem.offsetWidth;
          questionElem.classList.add('blink');
        }
      }
      // === FIN animation clignotement ===

      if(state.mode==="text"){
        // afficher ref
        E.textMode.style.display='block'; E.audioMode.style.display='none';
        E.vNum.textContent=q.verse; E.sName.textContent=q.name;
        E.vText.style.display='none'; E.vText.innerHTML='';
        E.answersText.style.display='none'; if(E.next1) E.next1.style.display='none'; E.showVerse.style.display='inline-block';
        const showBookBtn = E.textMode.querySelector('#showBook');
        if (showBookBtn) showBookBtn.style.display = 'inline-block'; // RÃ©afficher le bouton
      }else{
        // audio
        E.textMode.style.display='none'; E.audioMode.style.display='block';
        E.info.style.display='none'; E.answersAudio.style.display='none'; if(E.next2) E.next2.style.display='none'; E.showInfo.style.display='inline-block';
        const showBookBtn = E.audioMode.querySelector('#showBook');
        if (showBookBtn) showBookBtn.style.display = 'inline-block'; // RÃ©afficher le bouton
        loadAudio(q);
      }
}

    async function showVerseText(){
  const q = state.questions[state.idx];
  E.vText.innerHTML = '<span class="loading"></span>';
  E.vText.style.display = 'block';
  
  try {
    const key = `${q.surah}:${q.verse}`;
    
    if (!versesData) {
      throw new Error('DonnÃ©es non chargÃ©es');
    }
    
    const verseData = versesData[key];
    if (!verseData) {
      throw new Error(`Verset ${key} non trouvÃ©`);
    }
    
    window.currentAyahInfo = {
      text: verseData.text,
      surah: q.surah,
      surah_name: verseData.surah_name,
      verse: q.verse,
      page: verseData.page,
      juz: verseData.juz
    };
    
        E.vText.innerHTML = `<div style="font-size:24px;line-height:1.9;color:#0f172a">${verseData.text}</div>`;
    
    // Afficher le livre du Coran avec la page
showQuranBook(verseData.page, q.verse);

    // Masquer le bouton "Ø¹Ø±Ø¶ Ø§Ù„ØµÙØ­Ø©" pendant la rÃ©ponse
    const showBookBtn = E.textMode.querySelector('#showBook');
    if (showBookBtn) showBookBtn.style.display = 'none';

  } catch(e) {
    console.error('Erreur:', e);
    E.vText.innerHTML = `<div style="color:var(--red)">Ø®Ø·Ø£: ${e.message}</div>`;
  }
  
  E.answersText.style.display = 'flex';
  E.showVerse.style.display = 'none';
}

    function audioUrlEveryAyah(reciterId,surah,verse){
      const r = RECITERS.find(x=>x.id===reciterId) || RECITERS[0];
      const s = String(surah).padStart(3,'0');
      const v = String(verse).padStart(3,'0');
      return `https://everyayah.com/data/${r.path}/${s}${v}.mp3`;
    }
    function audioFallbacks(surah,verse){
      // Fallback alquran.cloud (media per ayah)
      return [
        `https://cdn.islamic.network/quran/audio/128/ar.alafasy/${surah}${String(verse).padStart(3,'0')}.mp3`,
        `https://api.alquran.cloud/v1/ayah/${surah}:${verse}/ar.alafasy` // media endpoint accepte GET -> redirection/JSON; gardÃ© en secours
      ];
    }

    async function loadAudio(q){
  try {
    const s = String(q.surah).padStart(3,'0');
    const v = String(q.verse).padStart(3,'0');
    const reciterPath = RECITERS.find(x=>x.id===state.reciter)?.path || 'Hudhaify_128kbps';
    const audioPath = `./audios/${reciterPath}/${s}${v}.mp3`;
    
    console.log('ğŸ”Š Chargement:', audioPath);
    
    E.player.src = audioPath;
    
    // ATTENDRE que loadstart se dÃ©clenche (pas canplaythrough!)
    await new Promise((resolve, reject) => {
      const timeout = setTimeout(() => {
        E.player.removeEventListener('loadstart', onLoadStart);
        E.player.removeEventListener('error', onError);
        resolve(); // RÃ©soudre mÃªme si pas de loadstart (offline)
      }, 500);
      
      const onLoadStart = () => {
        clearTimeout(timeout);
        E.player.removeEventListener('loadstart', onLoadStart);
        E.player.removeEventListener('error', onError);
        resolve();
      };
      
      const onError = (e) => {
        clearTimeout(timeout);
        E.player.removeEventListener('loadstart', onLoadStart);
        E.player.removeEventListener('error', onError);
        reject(e);
      };
      
      E.player.addEventListener('loadstart', onLoadStart, {once: true});
      E.player.addEventListener('error', onError, {once: true});
    });
    
    await E.player.play().catch(err => console.warn('âš ï¸ Autoplay:', err.message));
    console.log('âœ… Audio chargÃ©');
    
  } catch(err) {
    console.error('âŒ Erreur audio:', err);
  }
}

    // Ligne 553 (remplacez lâ€™ancienne fonction showAudioInfo):
async function showAudioInfo(){
  const q = state.questions[state.idx];
  
  try {
    const key = `${q.surah}:${q.verse}`;
    
    if (!versesData) {
      throw new Error('DonnÃ©es non chargÃ©es');
    }
    
    const verseData = versesData[key];
    if (!verseData) {
      throw new Error(`Verset ${key} non trouvÃ©`);
    }
    
    E.tAudio.textContent = verseData.text;
    E.sAudio.textContent = verseData.surah_name;
    E.nAudio.textContent = verseData.verse;
    E.pAudio.textContent = verseData.page;
    E.jAudio.textContent = verseData.juz;

    // Afficher le livre du Coran avec la page
    showQuranBook(verseData.page, verseData.verse);

    // Masquer le bouton "Ø¹Ø±Ø¶ Ø§Ù„ØµÙØ­Ø©" pendant la rÃ©ponse
    const showBookBtn = E.audioMode.querySelector('#showBook');
    if (showBookBtn) showBookBtn.style.display = 'none';
    
  } catch(e) {
    console.error('Erreur:', e);
    E.tAudio.textContent = "Ø®Ø·Ø£: " + e.message;
    E.sAudio.textContent = "ØŸ";
    E.nAudio.textContent = "ØŸ";
    E.pAudio.textContent = "ØŸ";
    E.jAudio.textContent = "ØŸ";
  }
  
  E.info.style.display = 'block';
  E.answersAudio.style.display = 'flex';
  E.showInfo.style.display = 'none';
}


async function showBook() {
  const q = state.questions[state.idx];
  
  try {
    const key = `${q.surah}:${q.verse}`;
    
    if (!versesData) {
      throw new Error('DonnÃ©es non chargÃ©es');
    }
    
    const verseData = versesData[key];
    if (!verseData) {
      throw new Error(`Verset ${key} non trouvÃ©`);
    }
    
    // Afficher JUSTE le livre SANS le badge du verset
    showQuranBookOnly(verseData.page);
    
  } catch(e) {
    console.error('Erreur:', e);
  }
}

function showQuranBookOnly(pageNum) {
  if (!pageNum || pageNum < 1 || pageNum > 604) {
    E.quranBook.classList.remove('show');
    return;
  }
  
  const isOdd = pageNum % 2 !== 0;
  
  // RÃ©initialiser
  E.leftPage.classList.add('empty');
  E.rightPage.classList.add('empty');
  E.leftContent.innerHTML = '';
  E.rightContent.innerHTML = '';
  
  // Enlever ancien badge s'il existe
  const oldBadge = E.quranBook.querySelector('.verse-number-badge');
  if (oldBadge) oldBadge.remove();
  
  if (isOdd) {
    E.leftPage.classList.remove('empty');  
    E.leftContent.innerHTML = `            
      <div class="page-number">${pageNum}</div>
      <div class="page-lines">
        <div class="page-line"></div>
        <div class="page-line"></div>
        <div class="page-line"></div>
        <div class="page-line"></div>
        <div class="page-line"></div>
      </div>
      <div class="page-label">ØµÙØ­Ø© ${pageNum}</div>
    `;
  } else {
    E.rightPage.classList.remove('empty'); 
    E.rightContent.innerHTML = `           
      <div class="page-number">${pageNum}</div>
      <div class="page-lines">
        <div class="page-line"></div>
        <div class="page-line"></div>
        <div class="page-line"></div>
        <div class="page-line"></div>
        <div class="page-line"></div>
      </div>
      <div class="page-label">ØµÙØ­Ø© ${pageNum}</div>
    `;
  }
  
  E.quranBook.classList.add('show');
}

    function approxPage(surah,verse){
      // RÃ¨gles connues exigÃ©es:
      if(surah===1) return 1;
      if(surah===2 && verse<=5) return 2;
      // Approximation (remplacer par table rÃ©elle pour exactitude parfaite)
      const before = totalVersesBefore(surah);
      const total = before + verse;
      return Math.max(1, Math.min(604, Math.ceil(total/10.32)));
    }
    function approxJuz(surah,verse){
      const before = totalVersesBefore(surah);
      const total = before + verse;
      return Math.max(1, Math.min(30, Math.ceil(total/208)));
    }
    function totalVersesBefore(surah){
      let sum=0; for(const s of SOURATES){ if(s.num<surah) sum+=s.versets; } return sum;
    }

    function record(isOk){
  const q=state.questions[state.idx];
  if(isOk){ state.ok++; E.ok.textContent=state.ok; } else { state.ko++; E.ko.textContent=state.ko; }
  state.history.push({
    q, isOk, at:new Date()
  });
  saveQuizState();  // Sauvegarder aprÃ¨s chaque rÃ©ponse
  
  // Passer directement Ã  la question suivante
  setTimeout(() => {
    next();
  }, 500);
}    

    function next(){ 
 state.idx++; 
 hideQuranBook();    // Cacher le livre AVANT de montrer la prochaine question
 saveQuizState();    // Sauvegarder avant de changer de question
 showQuestion(); 
}

    function endQuiz(){
      stopTimer();
      state.endTime = new Date();
      // remplir rÃ©sultats
      E.fOk.textContent = state.ok.toString();
      E.fKo.textContent = state.ko.toString();
      E.fTime.textContent = fmtMs(state.activeMs);
      E.tStart.textContent = state.startTime.toLocaleString('fr-FR',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit'});
      E.tEnd.textContent = state.endTime.toLocaleString('fr-FR',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit'});
      const tot = state.ok + state.ko;
      const pct = tot>0 ? Math.round((state.ok/tot)*100) : 0;
      E.pct.textContent = pct.toString()+'%';
      // historique
      E.hist.innerHTML = state.history.map((h,i)=>{
        const cls = h.isOk ? 'ok' : 'ko';
        const icon = h.isOk ? 'âœ“' : 'âœ—';
        const when = h.at.toLocaleString('fr-FR',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit'});
        return `<div class="item ${cls}">
          <strong>${icon} Ø§Ù„Ø³Ø¤Ø§Ù„ ${i+1}:</strong> Ø§Ù„Ø¢ÙŠØ© <span class="blue">${h.q.verse}</span> Ù…Ù† Ø³ÙˆØ±Ø© <span class="blue">${h.q.name}</span>
          <br><small>Ø§Ù„ÙˆÙ‚Øª: ${when}</small>
        </div>`;
      }).join('');
      goto('results');
      clearQuizState();     // Nettoyer la sauvegarde Ã  la fin du quiz
    }

    // Service Worker inline (cache de base)
    // Service Worker externe
function registerSW(){
  if(!('serviceWorker' in navigator)) return;
  
  // Essayer d'abord le SW local dans le dossier racine
  navigator.serviceWorker.register('/service-worker.js')
    .then(reg => {
      console.log('âœ… Service Worker enregistrÃ© (racine)');
      
      // Ã‰couter les mises Ã  jour
      reg.addEventListener('updatefound', () => {
        const newWorker = reg.installing;
        newWorker.addEventListener('statechange', () => {
          if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
            console.log('ğŸ”„ Nouvelle version disponible');
          }
        });
      });
    })
    .catch(err => {
      console.warn('âš ï¸ Erreur SW racine, fallback vers ancien chemin:', err);
      
      // Fallback vers l'ancien chemin
      navigator.serviceWorker.register('/AudioVersets_V1_Hors_Connexion/sw.js')
        .then(reg => console.log('âœ… Service Worker enregistrÃ© (fallback)'))
        .catch(err => console.error('âŒ Erreur SW:', err));
    });
}
  </script>
</body>
</html>
